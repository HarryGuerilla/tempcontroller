#!/usr/bin/env node
var debug = require('debug')('tempcontroller'),
    app = require('../app'),
    temp = require('../lib/temp'),
    data = require('../lib/data'),
    sqlite3 = require('sqlite3'),
    db = new sqlite3.Database('./data.db'),
    schedule = require('node-schedule');

function logTemperature() {
  temp.current(function(temp) {
    console.log('Current temperature is: ' + temp);
    var time = (new Date).getTime();
    data.save(['batch', time, "[ " + time + ", " + temp + " ]"]);
  });
  setTimeout(logTemperature, 60000);
}

var j = schedule.scheduleJob({hour: 0, minute: 30}, function(){
  console.log('saving data...');
  data.write(db);
});

app.set('port', process.env.PORT || 3001);

logTemperature();

var server = app.listen(app.get('port'), function() {
  debug('Express server listening on port ' + server.address().port);
});

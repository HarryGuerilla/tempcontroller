#!/usr/bin/env node
var debug = require('debug')('tempcontroller'),
    b = require('bonescript'),
    app = require('../app'),
    temp = require('../lib/temp'),
    data = require('../lib/data'),
    sqlite3 = require('sqlite3'),
    db = new sqlite3.Database('./data.db'),
    schedule = require('node-schedule'),
    exec = require('child_process').exec;

function logTemperature() {
  temp.current(function(temp) {
    console.log('Current temperature is: ' + temp);
    var time = (new Date).getTime();
    data.save(['batch', time, "[ " + time + ", " + temp + " ]"]);
  });
  setTimeout(logTemperature, 60000);
}

exec('echo BB-1WIRE-P9-22 > $SLOTS', function(err, stdout, stderr){
  console.log('loading 1-wire temp sensor:' + stdout);
  if (err !== null) {
    console.log('error loading temp sensor:' + err);
  }
})

var j = schedule.scheduleJob({hour: 0, minute: 30}, function(){
  console.log('saving data...');
//  data.write(db);
});

app.set('port', process.env.PORT || 3001);

b.pinMode('USR0', b.OUTPUT);
b.digitalWrite('USR0', b.LOW);
b.pinMode('USR1', b.OUTPUT);
b.digitalWrite('USR1', b.LOW);
b.pinMode('USR2', b.OUTPUT);
b.digitalWrite('USR2', b.LOW);
b.pinMode('USR3', b.OUTPUT);
b.digitalWrite('USR3', b.LOW);

logTemperature();

var server = app.listen(app.get('port'), function() {
  debug('Express server listening on port ' + server.address().port);
});
